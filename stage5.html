<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!-- ãƒ¢ãƒã‚¤ãƒ«æ‹¡å¤§ã‚’æŠ‘æ­¢ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ã‚¹ãƒãƒ›æ“ä½œã‚Œã‚“ã—ã‚…ã†ï¼šã‚¹ãƒ†ãƒ¼ã‚¸5ï¼ˆãƒ”ãƒ³ãƒï¼‰</title>
  <style>
    :root{
      /* ã‚¹ãƒ†ãƒ¼ã‚¸5ã®è‰²ï¼ˆãƒ‘ãƒ¼ãƒ—ãƒ«ç³»ï¼šæ–°é®®ã•/å¤‰åŒ–ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ */
      --btn-c1:#d7a7ff;
      --btn-c2:#7b2fff;
      /* ã‚¯ãƒªã‚¢å¾Œã¯ã‚°ãƒªãƒ¼ãƒ³æ¡ˆå†…ã§çµ±ä¸€ */
      --btn-clear1:#7fffaf;
      --btn-clear2:#28a745;
    }
    html,body{
      height:100%; margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Helvetica Neue", Arial, sans-serif;
      background:#f6f7fb; color:#222; font-size:24px;
      touch-action: manipulation; -webkit-tap-highlight-color:transparent;
    }
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{background:#fff;padding:28px;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);max-width:640px;width:100%}
    .nav{display:flex;gap:12px;margin:0 0 12px}
    .nav a{font-size:1rem;text-decoration:none;background:#eef2ff;padding:8px 12px;border-radius:999px}
    .title{font-size:2rem;font-weight:700;margin:0 0 12px}
    .desc{font-size:1.2rem;line-height:1.7;margin:0 0 16px}
    .arena{display:flex;justify-content:center;margin:16px 0}
    .tap-btn{
      width:260px;height:260px;border:none;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--btn-c1), var(--btn-c2));
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      color:#fff;font-size:1.4rem;font-weight:700;cursor:pointer;
      touch-action:none; /* 2æœ¬æŒ‡ã‚¸ã‚§ã‚¹ãƒãƒ£ã‚’è¦ç´ å†…ã§å®Œçµ */
    }
    .status{font-size:1.3rem;font-weight:700;text-align:center;min-height:2em;margin:14px 0}
    .bar-wrap{background:#eef2ff;height:20px;border-radius:999px;overflow:hidden;margin-bottom:12px}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#65d06e,#2fb44d);transition:width .2s ease}
    .row{display:flex;justify-content:space-between;font-size:1.1rem;margin-bottom:12px}
    .hint{font-size:1.2rem;background:#fffbea;border:2px solid #ffe58f;padding:12px;border-radius:12px}
    .clear{display:none;text-align:center;color:#1f7a2f;font-weight:700;font-size:1.5rem;margin-top:14px}
    .controls{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .controls button{font-size:1rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="nav">
        <a href="./">â† ã‚¹ãƒ†ãƒ¼ã‚¸1</a>
        <a href="./stage2.html">â† ã‚¹ãƒ†ãƒ¼ã‚¸2</a>
        <a href="./stage3.html">â† ã‚¹ãƒ†ãƒ¼ã‚¸3</a>
        <a href="./stage4.html">â† ã‚¹ãƒ†ãƒ¼ã‚¸4</a>
      </div>
      <p class="title">ã‚¹ãƒ†ãƒ¼ã‚¸5ï¼šãƒ”ãƒ³ãƒï¼ˆæ‹¡å¤§ãƒ»ç¸®å°ï¼‰ã®ã‚Œã‚“ã—ã‚…ã†</p>
      <p class="desc">ä¸¸ã®ä¸Šã§ <strong>2æœ¬æŒ‡</strong> ã‚’é–‹ãï¼ˆæ‹¡å¤§ï¼‰ã‹é–‰ã˜ã‚‹ï¼ˆç¸®å°ï¼‰ã¨æˆåŠŸã§ã™ã€‚<br>2æœ¬æŒ‡ã®é–“éš”ãŒ <strong>20% ä»¥ä¸Š</strong> å¤‰ã‚ã‚‹ã¨ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚</p>

      <div class="arena">
        <button id="tapBtn" class="tap-btn" aria-label="ã“ã“ã§2æœ¬æŒ‡ãƒ”ãƒ³ãƒ">2æœ¬æŒ‡ã§æ‹¡å¤§/ç¸®å°</button>
      </div>

      <div id="status" class="status">æº–å‚™OKã€‚ä¸¸ã®ä¸Šã«2æœ¬æŒ‡ã‚’ç½®ã„ã¦ã€åºƒã’ã‚‹/ã™ã¼ã‚ã‚‹å‹•ãã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</div>
      <div class="bar-wrap"><div id="bar" class="bar"></div></div>
      <div class="row">
        <div>æˆåŠŸæ•°ï¼š<strong id="count">0</strong></div>
        <div>ã®ã“ã‚Šï¼š<strong id="left">5</strong></div>
      </div>

      <div id="hint" class="hint">
        ã‚³ãƒ„ï¼šã¾ãš2æœ¬æŒ‡ã‚’ã€Œä¸¸ã®ä¸Šã€ã«ç½®ã„ã¦ã‹ã‚‰ã€ã‚†ã£ãã‚Šåºƒã’ã‚‹/ç¸®ã‚ã‚‹ã€‚1æœ¬æŒ‡ã ã‘ã§ã¯æˆåŠŸã«ãªã‚Šã¾ã›ã‚“ã€‚
      </div>
      <div id="clear" class="clear">ğŸ‰ ã‚¯ãƒªã‚¢ï¼ãƒ”ãƒ³ãƒæ“ä½œã¯ãƒãƒƒãƒãƒªã§ã™ã€‚æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸é€²ã¿ã¾ã—ã‚‡ã†ã€‚</div>

      <div class="controls">
        <button id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>

  <!-- iOS: ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—/ãƒ”ãƒ³ãƒã®ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¤§ã‚’æŠ‘æ­¢ -->
  <script>
    (function(){
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(e){
        const now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
      }, { passive:false });
      document.addEventListener('gesturestart', function(e){ e.preventDefault(); }, { passive:false });
    })();
  </script>

  <script>
    (function(){
      const tapBtn  = document.getElementById('tapBtn');
      const status  = document.getElementById('status');
      const bar     = document.getElementById('bar');
      const clearEl = document.getElementById('clear');
      const resetEl = document.getElementById('reset');
      const countEl = document.getElementById('count');
      const leftEl  = document.getElementById('left');
      const hintEl  = document.getElementById('hint');

      const GOAL = 5;
      const SCALE_THRESHOLD = 1.2; // 20% ä»¥ä¸Šå¤‰åŒ–ã§æˆåŠŸ
      let count = 0, cleared = false;

      // 2æœ¬æŒ‡ç®¡ç†
      const pointers = new Map(); // id -> {x,y}
      let baseDist = 0;           // ãƒ”ãƒ³ãƒé–‹å§‹æ™‚ã®è·é›¢
      let pinching = false;
      let successLocked = false;  // 1ã‚¸ã‚§ã‚¹ãƒãƒ£ã«ã¤ã1å›ã ã‘æˆåŠŸ

      function updateUI(){
        countEl.textContent = count;
        leftEl.textContent  = Math.max(0, GOAL - count);
        bar.style.width     = Math.min(100, Math.round(count/GOAL*100)) + '%';
        if (!cleared && count >= GOAL){
          cleared = true;
          tapBtn.textContent = "æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ â–¶";
          tapBtn.style.background =
            "radial-gradient(circle at 30% 30%, var(--btn-clear1), var(--btn-clear2))";
          status.textContent = "ãŠè¦‹äº‹ï¼ãƒ”ãƒ³ãƒæ“ä½œã¯ãƒãƒƒãƒãƒªã§ã™ã€‚";
          clearEl.style.display = 'block';
          hintEl.textContent = "ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸é€²ã¿ã¾ã—ã‚‡ã†ï¼";
        }
      }

      function reset(){
        count=0; cleared=false; pinching=false; successLocked=false; baseDist=0;
        pointers.clear();
        tapBtn.textContent = "2æœ¬æŒ‡ã§æ‹¡å¤§/ç¸®å°";
        tapBtn.style.background =
          "radial-gradient(circle at 30% 30%, var(--btn-c1), var(--btn-c2))";
        status.textContent = "æº–å‚™OKã€‚ä¸¸ã®ä¸Šã«2æœ¬æŒ‡ã‚’ç½®ã„ã¦ã€åºƒã’ã‚‹/ã™ã¼ã‚ã‚‹å‹•ãã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
        hintEl.textContent = "ã‚³ãƒ„ï¼šã¾ãš2æœ¬æŒ‡ã‚’ã€Œä¸¸ã®ä¸Šã€ã«ç½®ã„ã¦ã‹ã‚‰ã€ã‚†ã£ãã‚Šåºƒã’ã‚‹/ç¸®ã‚ã‚‹ã€‚1æœ¬æŒ‡ã ã‘ã§ã¯æˆåŠŸã«ãªã‚Šã¾ã›ã‚“ã€‚";
        clearEl.style.display = 'none';
        updateUI();
      }

      function dist(){ // ç¾åœ¨ã®2ç‚¹é–“è·é›¢
        const it = pointers.values();
        const p1 = it.next().value, p2 = it.next().value;
        if (!p1 || !p2) return 0;
        const dx = p2.x - p1.x, dy = p2.y - p1.y;
        return Math.hypot(dx, dy);
      }

      function onPointerDown(e){
        if (cleared){ /* æ¬¡ã¸ */ window.location.href = "./stage6.html"; return; }
        // ãƒœã‚¿ãƒ³ä¸Šã®2æœ¬æŒ‡ã ã‘æ‰±ã†
        pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });
        if (pointers.size === 2){
          baseDist = dist();
          pinching = true;
          successLocked = false;
          status.textContent = "ãã®ã¾ã¾æŒ‡ã‚’åºƒã’ã‚‹ã‹ã€ã™ã¼ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
        } else if (pointers.size > 2){
          // 3æœ¬ä»¥ä¸Šã¯å¯¾è±¡å¤–ï¼šæœ€åˆã®2æœ¬ã§è©•ä¾¡
          status.textContent = "2æœ¬æŒ‡ã§æ“ä½œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
        }
      }

      function onPointerMove(e){
        if (!pointers.has(e.pointerId)) return;
        pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });
        if (!pinching || pointers.size < 2 || baseDist <= 0) return;

        const current = dist();
        if (current <= 0) return;
        const scale = current / baseDist;

        if (!successLocked && (scale >= SCALE_THRESHOLD || scale <= 1 / SCALE_THRESHOLD)){
          successLocked = true; // ã“ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ã§1å›ã ã‘
          count++;
          status.textContent = scale > 1 ? "æ‹¡å¤§æˆåŠŸï¼" : "ç¸®å°æˆåŠŸï¼";
          updateUI();
        }
      }

      function onPointerUp(e){
        // 2æœ¬æŒ‡â†’1æœ¬æŒ‡ã«ãªã£ãŸã‚‰ã‚¸ã‚§ã‚¹ãƒãƒ£çµ‚äº†
        pointers.delete(e.pointerId);
        if (pointers.size < 2){
          pinching = false;
          baseDist = 0;
          successLocked = false;
          if (!cleared){
            status.textContent = "ã‚‚ã†ä¸€åº¦ã€2æœ¬æŒ‡ã§æ‹¡å¤§/ç¸®å°ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
          } else {
            // ã‚¯ãƒªã‚¢å¾Œã¯ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã¨ã—ã¦å‹•ä½œ
            window.location.href = "./stage6.html";
          }
        }
      }

      if (window.PointerEvent){
        tapBtn.addEventListener('pointerdown', onPointerDown, { passive:true });
        tapBtn.addEventListener('pointermove', onPointerMove, { passive:true });
        tapBtn.addEventListener('pointerup',   onPointerUp,   { passive:true });
        tapBtn.addEventListener('pointercancel', onPointerUp,  { passive:true });
        tapBtn.addEventListener('pointerout',    onPointerUp,  { passive:true });
        tapBtn.addEventListener('pointerleave',  onPointerUp,  { passive:true });
      } else {
        // å¤ã„ç’°å¢ƒå‘ã‘ï¼ˆç°¡æ˜“fallbackï¼‰
        tapBtn.addEventListener('touchstart', (e)=>{
          if (e.touches.length > 0){
            pointers.clear();
            for (let i=0;i<Math.min(2,e.touches.length);i++){
              pointers.set(i, { x:e.touches[i].clientX, y:e.touches[i].clientY });
            }
            if (pointers.size === 2){ baseDist = dist(); pinching = true; successLocked=false; }
          }
        }, { passive:true });
        tapBtn.addEventListener('touchmove', (e)=>{
          if (e.touches.length >= 2){
            pointers.set(0, { x:e.touches[0].clientX, y:e.touches[0].clientY });
            pointers.set(1, { x:e.touches[1].clientX, y:e.touches[1].clientY });
            onPointerMove({ pointerId:0, clientX:e.touches[0].clientX, clientY:e.touches[0].clientY });
          }
        }, { passive:true });
        tapBtn.addEventListener('touchend', onPointerUp, { passive:true });
      }

      resetEl.addEventListener('click', reset);
      reset();
    })();
  </script>
</body>
</html>
